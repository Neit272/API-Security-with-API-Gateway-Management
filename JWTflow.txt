participant User
participant KongGW
participant API
participant KongAdmin


    User->>KongGW: POST /api/public/signup (username, password)
    KongGW->>API: Credentials
    API->>KongAdmin: GET /consumers/{username}
    alt Consumer chưa tồn tại
        KongAdmin-->>API: 404 Not Found
        API->>KongAdmin: POST /consumers (username)
        KongAdmin-->>API: 201 Created (consumer_id)
    else Consumer đã tồn tại
        KongAdmin-->>API: 200 OK (consumer_id)
    end
    API->>KongAdmin: POST /consumers/{consumer_id}/jwt (algorithm=HS256)
    KongAdmin-->>API: 201 Created (jwt_credential_id, key, secret, algorithm)
    API->>API: Lưu user vào DB (username, password_hash, secret)
    API-->>KongGW: 201 Created (Signup thành công)
    KongGW-->>User: 201 Created (Signup thành công)

    User->>KongGW: POST /api/public/signin (username, password)
    KongGW->>API: Credentials
    API->>API: Kiểm tra username, password
    alt Đúng mật khẩu
        API->>KongAdmin: GET /consumers/{username}
        KongAdmin-->>API: 200 OK (consumer_id)
        API->>KongAdmin: GET /consumers/{consumer_id}/jwt
        alt Đã có JWT credential
            KongAdmin-->>API: 200 OK (danh sách credential)
            API->>API: Lấy secret từ DB tương ứng
        else Chưa có JWT credential
            KongAdmin-->>API: 200 OK (empty list)
            API->>KongAdmin: POST /consumers/{consumer_id}/jwt (algorithm=HS256)
            KongAdmin-->>API: 201 Created (key, secret)
            API->>API: Lưu/Update secret vào DB
        end
        API->>API: Ký JWT access token với secret
        API-->>KongGW: 200 OK (access_token, refresh_token, ...)
        KongGW-->>User: 200 OK (access_token, refresh_token, ...)
    else Sai mật khẩu
        API-->>KongGW: 401 Unauthorized
        KongGW-->>User: 401 Unauthorized
    end

    User->>KongGW: GET /api/jwt/info (Authorization: Bearer access_token)
    KongGW->>KongGW: Validate access_token (signature, exp, claims)
    alt Token hợp lệ
        KongGW->>API: Forward request (thêm X-Consumer-Username, X-Consumer-ID)
        API-->>KongGW: 200 OK (protected data)
        KongGW-->>User: 200 OK (protected data)
    else Token không hợp lệ/hết hạn
        KongGW-->>User: 401 Unauthorized
    end
    User->>KongGW: POST /api/public/refresh (refresh_token)
    KongGW->>API: refresh_token
    API->>API: Kiểm tra refresh_token trong DB
    alt Refresh token hợp lệ và chưa hết hạn
        API->>API: Tìm user, lấy secret, ký mới access_token, tạo refresh_token mới với expired time cũ
        API-->>KongGW: 200 OK (access_token mới, refresh_token mới)
        KongGW-->>User: 200 OK (access_token mới, refresh_token mới)
    else Refresh token không hợp lệ/hết hạn
        API-->>KongGW: 401 Unauthorized
        KongGW-->>User: 401 Unauthorized
    end